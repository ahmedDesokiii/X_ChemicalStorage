@using static X_ChemicalStorage.Constants.Helper
@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}
<!-- ================= HEADER (UNCHANGED) ================= -->
<div class="text-center">
    <div class="card border-0 py-3"
         style="background-color:#032b42 !important; border-radius:0 0 75px 0 ">
        <span class="text-center fs-1 fw-bold" style="color:#415E72 !important ">
            <i class="bi bi-speedometer2 ps-2 fs-1"></i>
            Dashboard
        </span>
    </div>
</div>

<section class="container-fluid warehouse-dashboard  mt-4" dir="ltr">

    <!-- ================= KPI CARDS ================= -->
 
    <div class="row g-4 mb-5 justify-content-center text-center">
        <div class="col-md-1"></div>
        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-primary d-flex">
                <i class="bi bi-box-seam p-2 rounded-3"></i>
                <div class="px-3 pt-2">
                    <span class="fs-5 fw-bold">Total Items</span>
                    <h3 class="kpi-number" data-count="@Model.TotalItems">0</h3>
                </div>
                
            </div>
        </div>

        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-success d-flex">
                <i class="bi bi-stack "></i>
                <div class="px-3 pt-2">
                <span class="fs-5 fw-bold">Available Qty</span>
                <h3 class="kpi-number" data-count="@Model.TotalAvailableQty">0</h3>
            </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-warning d-flex">
                <i class="bi bi-exclamation-circle"></i>
                <div class="px-3 pt-2">
                <span class="fs-5 fw-bold">Low Stock</span>
                <h3>@Model.UnderLimitItems</h3>
            </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-danger d-flex">
                <i class="bi bi-x-octagon"></i>
                <div class="px-3 pt-2">
                <span class="fs-5 fw-bold ">Expiring Lots</span>
                    <h3 class="kpi-number" data-count="@Model.ExpiringLots">0</h3>
        </div>
        </div>
        </div>
        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-info d-flex">
                <i class="bi bi-archive-fill"></i>
                    <div class="px-3 pt-2">
                <span class="fs-5 fw-bold">Total Lots</span>
                    <h3 class="kpi-number" data-count="@Model.TotalLots">0</h3>

            </div>
            </div>
        </div>
        <div class="col-md-1"></div>
    </div>
    <div class="card-body p-3">
        <!-- ================= ALERTS ================= -->
        
        <div class="row mb-4">
            <div class="col-lg-4 mx-auto">
                <div class="dashboard-card">
                    <h6 class="dashboard-title">
                        Items by Category
                    </h6>

                    <div id="categoryPieChart"></div>
                </div>
            </div>
            @if (Model.HasUnderLimitAlert || Model.HasExpiryAlert || Model.HasHazardAlert || Model.HasNearExpiryAlert)
            {
                <div class="col-lg-4 mx-auto">
                    @if (Model.HasNearExpiryAlert)
                    {
                        <div class="alert alert-dark alert-modern">
                            <i class="bi bi-exclamation-diamond-fill me-2"></i>
                            <b>Near Expiy Alert : </b>
                            batches expiring soon → <span class="fs-5 fw-bold mx-2">@Model.NearExpiringLots</span>
                        </div>
                    }
                    
                    @if (Model.HasUnderLimitAlert)
                    {
                        <div class="alert alert-info alert-modern">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <b>Low Stock Alert : </b>
                            items below minimum limit → <span class="fs-5 fw-bold mx-2">@Model.UnderLimitItems</span>
                        </div>
                    }

                    @if (Model.HasExpiryAlert)
                    {
                        <div class="alert alert-danger alert-modern">
                            <i class="bi bi-hourglass-split me-2"></i>
                            <b>Expiry Warning : </b>
                            batches expired → <span class="fs-5 fw-bold mx-2">@Model.ExpiringLots</span>
                        </div>
                    }

                    @if (Model.HasHazardAlert)
                    {
                        <div class="alert alert-warning alert-modern">
                            <i class="bi bi-shield-fill-check me-2"></i>
                            <b>Hazard Materials : </b>
                            items require special handling invalid SDS → <span class="fs-5 fw-bold mx-2">@Model.HazardItems</span>
                        </div>
                    }

                </div>
            }
            <div class="col-lg-4 mx-auto">
                <div class="dashboard-card text-center">
                    <h6 class="dashboard-title">
                        SDS Status Wave
                    </h6>
                    <div id="sdsWaveChart"></div>
                </div>
            </div>
            </div>
  
            <div class="row mb-4">
            <div class="col-lg-4">
                <div class="dashboard-card">
                    <h6 class="dashboard-title">
                        Lots Over Time
                    </h6>
                    <div id="lotsLineChart"></div>
                </div>
            </div>
                <!-- ================= Storage Condition Card ================= -->
                <div class="col-lg-4 mx-auto">
                    <div class="dashboard-card text-center">
                        <h6 class="dashboard-title">
                            Storage Condition Overview
                        </h6>
                        <!-- REQUIRED -->
                        <div id="storageConditionBar" ></div>
                    </div>
                </div>
            

            <div class="col-lg-4">
                <div class="dashboard-card">
                    <h6 class="dashboard-title">
                        Expiry Trend
                    </h6>
                    <div id="expiryLineChart"></div>
                </div>
            </div>
            </div>
    </div>

@* 
    <div class="module-card" data-module="Items Dashboard">
        <div class="card mb-4 shadow permission-card">
            <div class="card-header fs-5 fw-bold d-flex justify-content-between align-items-center
            collapse-header-amber"
                 data-bs-toggle="collapse"
                 data-bs-target="#collapseItem"
                 aria-expanded="true"
                 dir="ltr">

                <span class="text-dark fw-bold fs-4">
                    <i class="bi bi-pin-angle-fill fs-4 pe-3"></i>
                    Items Dashboard
                </span>

                <i class="bi bi-chevron-down fs-4"></i>
            </div>

        </div>
        </div> 

        
        <div id="collapseItem" class="collapse show">
            
        </div>
    *@
   

</section>

<!-- ================= Scripts ================= -->
<script>
    window.storageCondition = {
        room: @Model.StorageCondition.RoomTempCount,
        freezer: @Model.StorageCondition.FreezerCount,
        cold: @Model.StorageCondition.ColdCount
    };
</script>
@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="~/js/warehouse-dashboard.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const counters = document.querySelectorAll(".kpi-number");

            counters.forEach(counter => {
                const target = +counter.getAttribute("data-count");
                let current = 0;
                const increment = Math.max(1, Math.floor(target / 1000));

                const update = () => {
                    current += increment;
                    if (current >= target) {
                        counter.innerText = target;
                    } else {
                        counter.innerText = current;
                        requestAnimationFrame(update);
                    }
                };

                update();
            });

        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts not loaded");
                return;
            }

            const waveData = [
                @foreach (var item in Model.SdsWaveItems)
                {
                        var value = item.IsValid ? item.Quantity : -item.Quantity;
                        <text>{
                            x: "@item.ItemName",
                            y: @value,
                            status: "@(item.IsValid ? "Valid" : "Invalid")"
                        },</text>
                }
            ];

            const options = {
                chart: {
                    type: 'bar',
                    height: 260,
                    toolbar: { show: false },
                    animations: {
                        enabled: true,
                        easing: 'easeinout',
                        speed: 1200,
                        animateGradually: { enabled: true, delay: 40 },
                        dynamicAnimation: { enabled: true, speed: 900 }
                    }
                },

                plotOptions: {
                    bar: {
                        columnWidth: '38%',
                        borderRadius: 6
                    }
                },

                series: [{
                    name: 'SDS Status',
                    data: waveData
                }],

                grid: {
                    strokeDashArray: 4,
                    borderColor: '#e9ecef'
                },

                xaxis: {
                    labels: { show: false },
                    axisBorder: { show: false },
                    axisTicks: { show: false }
                },

                yaxis: {
                    labels: {
                        formatter: val => Math.abs(val)
                    }
                },

                colors: [
                    function ({ value }) {
                        return value >= 0
                            ? 'rgba(32,201,151,0.95)'   // Valid
                            : 'rgba(255,107,107,0.95)'; // Invalid
                    }
                ],

                tooltip: {
                    custom: function ({ seriesIndex, dataPointIndex, w }) {

                        const point = w.config.series[seriesIndex].data[dataPointIndex];
                        const qty = Math.abs(point.y);
                        const isValid = point.status === "Valid";

                        return `
                            <div class="sds-tooltip ${isValid ? 'valid' : 'invalid'}">
                                <div class="sds-title">${point.x}</div>
                                <div class="sds-qty">Quantity: <b>${qty}</b></div>
                                <div class="sds-badge">
                                    <span class="badge ${isValid ? 'bg-success' : 'bg-danger'}">
                                        ${point.status}
                                    </span>
                                </div>
                            </div>
                        `;
                    }
                },

                dataLabels: { enabled: false }
            };

            new ApexCharts(
                document.querySelector("#sdsWaveChart"),
                options
            ).render();
        });
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const el = document.querySelector("#storageConditionBar");
            if (!el || !window.storageCondition) return;

            const data = [
                storageCondition.room || 0,
                storageCondition.freezer || 0,
                storageCondition.cold || 0
            ];

            // لو مفيش داتا
            if (data.every(x => x === 0)) {
                el.innerHTML = "<p class='text-muted mt-5'>No storage data available</p>";
                return;
            }

            const options = {
                chart: {
                    type: 'bar',
                    height: 260,
                    toolbar: { show: false }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 10,
                        distributed: true, // 🔥 مهم
                        barHeight: '55%'
                    }
                },
                series: [{
                    name: 'Items',
                    data: data
                }],
                colors: [
                    '#F96E5B', // 🔴 Room Temp
                    '#AEDEFC', // 🔵 Freezer
                    '#3BC1A8'  // 🟢 Cold
                ],
                xaxis: {
                    categories: [
                        'Room Temp',
                        'Freezer °C',
                        '2–8 °C'
                    ]
                },
                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '14px',
                        fontWeight: 'bold'
                    }
                },
                tooltip: {
                    y: {
                        formatter: val => val + " Items"
                    }
                }
            };

            new ApexCharts(el, options).render();
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            var seriesData = @Html.Raw(Json.Serialize(
                            Model.CategorySummary.Select(x => x.ItemsCount)
                    ));

        var labelsData = @Html.Raw(Json.Serialize(
                        Model.CategorySummary.Select(x => x.CategoryName)
                ));

        var options = {
            chart: {
                type: 'pie',
                height: 330,
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 900,
                    animateGradually: {
                        enabled: true,
                        delay: 120
                    },
                    dynamicAnimation: {
                        enabled: true,
                        speed: 700
                    }
                }
            },

                series: seriesData,
                labels: labelsData,

                legend: {
                    position: 'bottom',
                    fontSize: '13px',
                    fontWeight: 500,
                    markers: {
                        radius: 12
                    }
                },

                dataLabels: {
                    enabled: true,
                    style: {
                        fontSize: '13px',
                        fontWeight: 'bold'
                    },
                    formatter: function (val, opts) {
                        return opts.w.config.series[opts.seriesIndex];
                    }
                },

                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " Items";
                        }
                    }
                },

                colors: [
                    '#FFCB61',
                    '#00809D',
                    '#FF894F',
                    '#7A7A73',
                    '#20c997',
                    
                ],

                stroke: {
                    width: 1,
                    colors: ['#ffffff']
                }
            };

            new ApexCharts(
                document.querySelector("#categoryPieChart"),
                options
            ).render();

        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const lotsLabels = @Html.Raw(Json.Serialize(Model.LotsOverTime.Select(x => x.Label)));
            const lotsData = @Html.Raw(Json.Serialize(Model.LotsOverTime.Select(x => x.Value)));

            const expiryLabels = @Html.Raw(Json.Serialize(Model.ExpiryTrend.Select(x => x.Label)));
            const expiryData = @Html.Raw(Json.Serialize(Model.ExpiryTrend.Select(x => x.Value)));

            function buildLineChart(el, data, labels, color) {
                return new ApexCharts(document.querySelector(el), {
                    chart: {
                        type: 'line',
                        height: 320,
                        toolbar: { show: false },
                        animations: {
                            enabled: true,
                            easing: 'easeinout',
                            speed: 900
                        }
                    },
                    series: [{
                        name: 'Count',
                        data: data
                    }],
                    xaxis: {
                        categories: labels
                    },
                    stroke: {
                        curve: 'smooth',
                        width: 3
                    },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.4,
                            opacityTo: 0.05,
                            stops: [0, 90, 100]
                        }
                    },
                    colors: [color],
                    markers: {
                        size: 4,
                        hover: { size: 6 }
                    },
                    grid: {
                        borderColor: '#eee',
                        strokeDashArray: 4
                    },
                    tooltip: {
                        theme: 'dark',
                        y: {
                            formatter: val => val + " Lots"
                        }
                    }
                });
            }

            buildLineChart(
                "#lotsLineChart",
                lotsData,
                lotsLabels,
                "#198754" // Green
            ).render();

            buildLineChart(
                "#expiryLineChart",
                expiryData,
                expiryLabels,
                "#dc3545" // Red
            ).render();

        });
    </script>




}


<!-- ================= Styles ================= -->
<style>

    #lineChart,
    #expiryLineChart {
        margin-top: 10px;
    }

    .dashboard-card {
        transition: .3s;
    }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 40px rgba(0,0,0,.18);
        }



    .storage-chart-card {
        border-radius: 18px;
        overflow: hidden;
    }

    .storage-dash-header {
        background: linear-gradient(135deg,#032b42,#064663);
        color: #fff;
        font-weight: 700;
        padding: 14px 16px;
        font-size: 1.05rem;
    }

    /* Chart */
    .storage-chart {
        min-height: 240px;
    }

    /* Mobile List */
    .storage-list {
        border-top: 1px solid #eee;
    }

    .storage-row {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        font-weight: 600;
        border-bottom: 1px solid #f1f1f1;
    }

        .storage-row:last-child {
            border-bottom: none;
        }

        .storage-row .icon {
            font-size: 1.4rem;
            margin-right: 12px;
        }

        .storage-row .label {
            flex-grow: 1;
        }

        .storage-row .count {
            font-weight: 800;
            font-size: 1.15rem;
        }

        /* Colors */
        .storage-row.room {
            color: #dc3545;
        }

        .storage-row.freezer {
            color: #0d6efd;
        }

        .storage-row.cold {
            color: #198754;
        }

    /* Glow Alert */
    .room-alert-glow {
        animation: softPulse 2s infinite;
        border-radius: 14px;
    }


    .lot-slider {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 10px;
    }

    .lot-card {
        min-width: 200px;
        padding: 16px;
        border-radius: 14px;
        color: #fff;
        cursor: pointer;
        box-shadow: 0 8px 22px rgba(0,0,0,.2);
    }

        .lot-card.high {
            background: linear-gradient(135deg,#dc3545,#842029);
        }

        .lot-card.medium {
            background: linear-gradient(135deg,#ffc107,#997404);
        }

        .lot-card.low {
            background: linear-gradient(135deg,#198754,#0f5132);
        }

    .kpi {
        border-radius: 18px;
        padding: 24px;
        color: #fff;
        box-shadow: 0 10px 30px rgba(0,0,0,.18);
        transition: .3s;
    }

        .kpi:hover {
            transform: translateY(-6px);
        }

        .kpi i {
            font-size: 32px;
            opacity: .9;
        }

        .kpi span {
            display: block;
            font-size: 14px;
            opacity: .85;
        }

        .kpi h3 {
            margin-top: 8px;
            font-weight: bold;
        }

    .kpi-info {
        background: linear-gradient(135deg,#3F9AAE,#ABDADC);
    }

    .kpi-primary {
        background: linear-gradient(135deg,#213C51,#084298);
    }

    .kpi-success {
        background: linear-gradient(135deg,#198754,#0f5132);
    }

    .kpi-warning {
        background: linear-gradient(135deg,#ffc107,#997404);
    }

    .kpi-danger {
        background: linear-gradient(135deg,#dc3545,#842029);
    }

    .dashboard-card {
        background: #fff;
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }

    .dashboard-title {
        font-weight: bold;
        margin-bottom: 16px;
    }

    .alert-modern {
        border-radius: 14px;
        padding: 14px 18px;
        box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }

    .collapse-header-amber {
        position: relative;
        background: linear-gradient( 120deg, rgba(255,193,7,.9), rgba(255,214,102,.7), rgba(255,193,7,.9) );
        border-radius: 14px 14px 0 0;
        padding: 14px 20px;
        box-shadow: 0 0 16px rgba(255,193,7,.55);
        transition: all .3s ease;
    }

        /* Glow Frame */
        .collapse-header-amber::before {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: 16px;
            background: linear-gradient( 120deg, rgba(255,193,7,.9), rgba(255,214,102,.7), rgba(255,193,7,.9) );
            filter: blur(10px);
            opacity: .6;
            z-index: -1;
        }

        /* Hover */
        .collapse-header-amber:hover {
            box-shadow: 0 0 24px rgba(255,193,7,.8);
        }

        /* Arrow Animation */
        .collapse-header-amber .bi-chevron-down {
            transition: transform .3s ease;
        }

        .collapse-header-amber[aria-expanded="true"] .bi-chevron-down {
            transform: rotate(180deg);
        }

    /* Apex Bar Hover Glow */
    .apexcharts-bar-area {
        transition: all 0.3s ease;
    }

        .apexcharts-bar-area:hover {
            filter: drop-shadow(0 0 10px rgba(0,255,180,0.6));
            transform: scale(1.04);
        }

    #categoryRadialChart {
        margin-top: 12px;
    }

    .apexcharts-radialbar .apexcharts-datalabel-value {
        color: #0f5132;
    }

</style>


