@using static X_ChemicalStorage.Constants.Helper
@model DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
}
<!-- ================= HEADER (UNCHANGED) ================= -->
<div class="text-center">
    <div class="card border-0 py-3"
         style="background-color:#032b42 !important; border-radius:0 0 75px 0 ">
        <span class="text-center fs-1 fw-bold" style="color:#415E72 !important ">
            <i class="bi bi-speedometer2 ps-2 fs-1"></i>
            Dashboard
        </span>
    </div>
</div>

<section class="container-fluid warehouse-dashboard mt-3" dir="ltr">

    <!-- ================= KPI CARDS ================= -->
    <div class="row g-4 mb-5 justify-content-center text-center">
        <div class="col-md-1"></div>
        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-primary">
                <i class="bi bi-box-seam"></i>
                <span class="fs-5">Total Items</span>
                <h3>@Model.TotalItems</h3>
            </div>
        </div>

        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-success">
                <i class="bi bi-stack"></i>
                <span class="fs-5">Available Quantity</span>
                <h3>@Model.TotalAvailableQty</h3>
            </div>
        </div>

        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-warning">
                <i class="bi bi-exclamation-circle"></i>
                <span class="fs-5">Low Stock</span>
                <h3>@Model.UnderLimitItems</h3>
            </div>
        </div>

        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-danger">
                <i class="bi bi-x-octagon"></i>
                <span class="fs-5">Expiring Lots</span>
                <h3>@Model.ExpiringLots</h3>
            </div>
        </div>
        <div class="col-xl-2 col-md-2 py-0">
            <div class="kpi kpi-info">
                <i class="bi bi-archive-fill"></i>
                <span class="fs-5">Total Lots</span>
                <h3>@Model.TotalLots</h3>
            </div>
        </div>
        <div class="col-md-1"></div>
    </div>

    <!-- ================= ALERTS ================= -->
    @if (Model.HasUnderLimitAlert || Model.HasExpiryAlert || Model.HasHazardAlert)
    {
        <div class="row mb-4">
            <!-- ================= Storage Condition Card ================= -->
            <div class="col-lg-4 mx-auto">
                <div class="dashboard-card text-center">
                    <h6 class="dashboard-title">
                        Storage Condition Overview
                    </h6>

                    <!-- REQUIRED -->
                    <div id="storageConditionBar" style="min-height:260px;"></div>
                </div>
            </div>

            <div class="col-lg-4 mx-auto">
                @if (Model.HasUnderLimitAlert)
                {
                    <div class="alert alert-danger alert-modern">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <b>Low Stock Alert:</b>
                        <span class="fs-6">@Model.UnderLimitItems</span> items below minimum limit
                    </div>
                }

                @if (Model.HasExpiryAlert)
                {
                    <div class="alert alert-warning alert-modern">
                        <i class="bi bi-hourglass-split me-2"></i>
                        <b>Expiry Warning:</b>
                        <span class="fs-6">@Model.ExpiringLots</span> batches expiring soon
                    </div>
                }

                @if (Model.HasHazardAlert)
                {
                    <div class="alert alert-info alert-modern">
                        <i class="bi bi-biohazard-fill me-2"></i>
                        <b>Hazard Materials:</b>
                        <span class="fs-6">@Model.HazardItems</span> items require special handling
                    </div>
                }

            </div>
            <div class="col-lg-4 mx-auto">
                <div class="dashboard-card text-center">
                    <h6 class="dashboard-title">
                        SDS Status Overview
                        @if (Model.SdsStatus.InvalidCount > 0)
                        {
                            <span class="badge bg-danger ms-2">
                                @Model.SdsStatus.InvalidCount Invalid
                            </span>
                        }
                    </h6>
                    <div class=" d-flex justify-content-center align-items-center">
            <div id="sdsStatusPie"></div>
        </div>
                  
                </div>
            </div>
        </div>
    }

</section>

<!-- ================= Scripts ================= -->
<script>
    window.storageCondition = {
        room: @Model.StorageCondition.RoomTempCount,
        freezer: @Model.StorageCondition.FreezerCount,
        cold: @Model.StorageCondition.ColdCount
    };
</script>
@section Scripts {

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="~/js/warehouse-dashboard.js"></script>
   
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            var options = {
                chart: {
                    type: 'pie',
                    height: 280
                },
                labels: ['Valid SDS', 'Invalid SDS'],
                series: [
                    @Model.SdsStatus.ValidCount,
                    @Model.SdsStatus.InvalidCount
                ],
                colors: [
                    '#198754', // Green - Valid
                    '#dc3545'  // Red - Invalid
                ],
                legend: {
                    position: 'bottom',
                    fontSize: '14px'
                },
                dataLabels: {
                    enabled: true,
                    formatter: function (val, opts) {
                        return opts.w.config.series[opts.seriesIndex];
                    }
                },
                tooltip: {
                    y: {
                        formatter: function (value) {
                            return value + " Items";
                        }
                    }
                },
                responsive: [{
                    breakpoint: 768,
                    options: {
                        chart: {
                            height: 240
                        },
                        legend: {
                            position: 'bottom'
                        }
                    }
                }]
            };

            var chart = new ApexCharts(
                document.querySelector("#sdsStatusPie"),
                options
            );

            chart.render();
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            if (typeof ApexCharts === "undefined") {
                console.error("ApexCharts not loaded");
                return;
            }

            if (!window.storageCondition) {
                console.error("storageCondition not found");
                return;
            }

            const el = document.querySelector("#storageConditionBar");
            if (!el) {
                console.error("storageConditionBar element not found");
                return;
            }

            const options = {
                chart: {
                    type: 'bar',
                    height: 260,
                    toolbar: { show: false }
                },
                plotOptions: {
                    bar: {
                        horizontal: true,
                        borderRadius: 8
                    }
                },
                series: [{
                    name: 'Items',
                    data: [
                        storageCondition.room || 0,
                        storageCondition.freezer || 0,
                        storageCondition.cold || 0
                    ]
                }],
                xaxis: {
                    categories: [
                        'Room Temp',
                        'Freezer -20°C',
                        '2–8 °C'
                    ]
                },
                colors: ['#dc3545'],
                dataLabels: {
                    enabled: true
                }
            };

            new ApexCharts(el, options).render();
        });
    </script>
}

<!-- ================= Styles ================= -->
<style>


    /* ================= Storage Condition ================= */

    .storage-chart-card {
        border-radius: 18px;
        overflow: hidden;
    }

    .storage-dash-header {
        background: linear-gradient(135deg,#032b42,#064663);
        color: #fff;
        font-weight: 700;
        padding: 14px 16px;
        font-size: 1.05rem;
    }

    /* Chart */
    .storage-chart {
        min-height: 240px;
    }

    /* Mobile List */
    .storage-list {
        border-top: 1px solid #eee;
    }

    .storage-row {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        font-weight: 600;
        border-bottom: 1px solid #f1f1f1;
    }

        .storage-row:last-child {
            border-bottom: none;
        }

        .storage-row .icon {
            font-size: 1.4rem;
            margin-right: 12px;
        }

        .storage-row .label {
            flex-grow: 1;
        }

        .storage-row .count {
            font-weight: 800;
            font-size: 1.15rem;
        }

        /* Colors */
        .storage-row.room {
            color: #dc3545;
        }

        .storage-row.freezer {
            color: #0d6efd;
        }

        .storage-row.cold {
            color: #198754;
        }

    /* Glow Alert */
    .room-alert-glow {
        animation: softPulse 2s infinite;
        border-radius: 14px;
    }


    .lot-slider {
        display: flex;
        gap: 16px;
        overflow-x: auto;
        padding-bottom: 10px;
    }

    .lot-card {
        min-width: 200px;
        padding: 16px;
        border-radius: 14px;
        color: #fff;
        cursor: pointer;
        box-shadow: 0 8px 22px rgba(0,0,0,.2);
    }

        .lot-card.high {
            background: linear-gradient(135deg,#dc3545,#842029);
        }

        .lot-card.medium {
            background: linear-gradient(135deg,#ffc107,#997404);
        }

        .lot-card.low {
            background: linear-gradient(135deg,#198754,#0f5132);
        }

    .kpi {
        border-radius: 18px;
        padding: 24px;
        color: #fff;
        box-shadow: 0 10px 30px rgba(0,0,0,.18);
        transition: .3s;
    }

        .kpi:hover {
            transform: translateY(-6px);
        }

        .kpi i {
            font-size: 32px;
            opacity: .9;
        }

        .kpi span {
            display: block;
            font-size: 14px;
            opacity: .85;
        }

        .kpi h3 {
            margin-top: 8px;
            font-weight: bold;
        }

    .kpi-info {
        background: linear-gradient(135deg,#3F9AAE,#ABDADC);
    }

    .kpi-primary {
        background: linear-gradient(135deg,#213C51,#084298);
    }

    .kpi-success {
        background: linear-gradient(135deg,#198754,#0f5132);
    }

    .kpi-warning {
        background: linear-gradient(135deg,#ffc107,#997404);
    }

    .kpi-danger {
        background: linear-gradient(135deg,#dc3545,#842029);
    }

    .dashboard-card {
        background: #fff;
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }

    .dashboard-title {
        font-weight: bold;
        margin-bottom: 16px;
    }

    .alert-modern {
        border-radius: 14px;
        padding: 14px 18px;
        box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }

</style>





