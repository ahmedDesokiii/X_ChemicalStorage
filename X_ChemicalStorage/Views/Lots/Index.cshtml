@model LotViewModel
@{
    ViewData["Title"] = "Lots";
}

<style>
    .lot-status-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.75rem;
        padding: 6px 10px;
        border-radius: 20px;
        font-weight: 700;
    }

    .card-hover {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .card-hover:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 12px 20px rgba(0,0,0,0.25);
            z-index: 10;
        }

    .card-header .text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .card-body .data-row {
        display: flex;
        justify-content: space-between;
        flex-wrap: wrap;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }

    .data-label {
        font-weight: 600;
        color: #415E72;
    }

    .data-value {
        font-weight: bold;
    }

    .barcode-img {
        height: 40px;
    }

    .icon-btn {
        border: none;
        background: none;
        padding: 0;
        font-size: 1.2rem;
        cursor: pointer;
    }

        .icon-btn:hover {
            transform: scale(1.15);
            color: #0d6efd;
        }

    .professional-card {
        border-radius: 12px;
        overflow: hidden;
    }
</style>

<!-- ================= HEADER ================= -->
<div class="card border-0 py-3" dir="ltr"
     style="background-color:#032b42;border-radius:0 0 75px 0">
    <span class="text-center fw-bold fs-1" style="color:#415E72">
        Inventory Lots <i class="bi bi-archive-fill ps-2"></i>
    </span>
</div>

<section class="container-fluid mt-3" dir="ltr">
    <div class="row">
        <div class="col-md-1"></div>

        <div class="col-md-10">
            <div class="card p-0">

                <!-- ================= ACTIONS ================= -->
                <div class="card-header bg-info-subtle">
                    <div class="row text-center">

                        @if (Model.CanCreateLot)
                        {
                            <div class="col-4">
                                <a class="btn border-0 bg-transparent fw-bold"
                                   onclick="setMode('receiving')"
                                   data-bs-toggle="modal"
                                   data-bs-target="#ListItemsModalCreate">
                                    <i class="bi bi-cart-plus-fill fs-1"></i><br />Add Lot
                                </a>
                            </div>
                        }

                        @if (Model.CanViewExpiryLots)
                        {
                            <div class="col-4">
                                <a class="btn border-0 bg-transparent fw-bold text-danger"
                                   data-bs-toggle="modal"
                                   data-bs-target="#ExpieryLotsModal">
                                    <i class="bi bi-list-task fs-1"></i><br />Expired
                                </a>
                            </div>
                        }

                        @if (Model.CanExchangeLot)
                        {
                            <div class="col-4">
                                <a class="btn border-0 bg-transparent fw-bold text-primary"
                                   data-bs-toggle="modal"
                                   data-bs-target="#ListItemsModalExchange">
                                    <i class="bi bi-cart-dash-fill fs-1"></i><br />Exchange
                                </a>
                            </div>
                        }

                    </div>
                </div>
              
                <!-- ================= BODY ================= -->
                <div class="card-body p-0">

                    @if (!Model.LotsList.Any())
                    {
                        <div class="alert  alert-warning mt-5">
                            <h4 class="alert-heading">No Lots</h4>
                            <p class="mb-0">No Lots have been added to the app yet.</p>
                        </div>
                    }
                    else
                    {

                        <!-- ======================= Mobile =============================== -->

                        <div class="d-block d-md-none px-2">
                            @foreach (var lot in Model.LotsList)
                            {
                                int daysLeft = (lot.ExpiryDate - DateTime.Now.Date).Value.Days;

                                string borderColor;
                                string badgeClass;
                                string badgeText;

                                if (daysLeft <= 0)
                                {
                                    borderColor = "#dc3545"; // danger
                                    badgeClass = "bg-danger text-white";
                                    badgeText = "Expired";
                                }
                                else if (daysLeft <= 7)
                                {
                                    borderColor = "#ffc107"; // warning
                                    badgeClass = "bg-warning text-dark";
                                    badgeText = "Near Expiry";
                                }
                                else
                                {
                                    borderColor = "#198754"; // success
                                    badgeClass = "bg-success text-white";
                                    badgeText = "Valid";
                                }

                                <div class="card professional-card mb-3 shadow-sm mt-3 border-0 card-hover position-relative"
                                     style="border-left:6px solid @borderColor;">

                                    <!-- STATUS BADGE -->
                                    <span class="position-absolute top-0 end-0 m-2 badge @badgeClass rounded-pill">
                                        @badgeText
                                    </span>

                                    <!-- HEADER -->
                                    <div class="card-header text-white py-2 px-3"
                                         style="background: linear-gradient(135deg, #032b42 0%, #0b4a6f 50%, #415E72 100%);">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="flex-grow-1 overflow-hidden">
                                                <h6 class="fw-bold mb-0 text-truncate">
                                                    @lot.Item?.Name
                                                </h6>
                                            </div>

                                            <div class="text-center ms-2">
                                                <img src="@lot.BarcodeImage"
                                                     class="barcode-img rounded-2 shadow-sm bg-white p-1" />
                                                <div style="font-size:10px" class="text-light">
                                                    @lot.LotNumber
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- BODY -->
                                    <div class="card-body py-2">
                                        <div class="data-row">
                                            <span class="data-label">Expiry Date:</span>
                                            <span class="fw-bold">@Convert.ToDateTime(lot.ExpiryDate).ToShortDateString()</span>
                                        </div>

                                        <div class="data-row">
                                            <span class="data-label">Available Quantity:</span>
                                            <span class="fw-bold bg-info-subtle rounded-4 px-3 py-1 ">@lot.AvilableQuantity</span>
                                        </div>

                                        <div class="data-row">
                                            <span class="data-label">Location:</span>
                                            <span class="fw-bold">Room[@lot.Location?.RoomNum]</span>
                                        </div>

                                        <div class="data-row">
                                            <span class="data-label">SDS:</span>
                                            <span class="badge @(lot.SDS == true ? "bg-success-subtle text-success" : "bg-danger-subtle text-danger")">
                                                @(lot.SDS == true ? "Valid" : "Invalid")
                                            </span>
                                        </div>
                                    </div>

                                    <!-- FOOTER ACTIONS -->
                                    <div class="card-footer bg-light border-0 d-flex justify-content-around py-2">
                                        @if (Model.CanViewDetails)
                                        {
                                            <a class="icon-btn"
                                               asp-controller="Lots"
                                               asp-action="SelectedLot"
                                               asp-route-Id="@lot.Id">
                                                <i class="bi bi-eye-fill fs-2"></i>
                                            </a>
                                        }
                                        @if (Model.CanEditLot)
                                        {
                                            <span class="icon-btn text-secondary"
                                                  title="Cannot Edit Lot !"
                                                  style="cursor:not-allowed; opacity:.45;">

                                                <i class="bi bi-pencil-square fs-4"></i>
                                            </span>
                                        }
                                        @if (Model.CanDeleteLot)
                                        {
                                            <a class="icon-btn text-danger"
                                               onclick="DeleteLot('@lot.Id')">
                                                <i class="bi bi-trash3-fill fs-2"></i>
                                            </a>
                                        }

                                        @if (Model.CanPrintBarcode)
                                        {
                                            <a class="icon-btn"
                                               asp-controller="Lots"
                                               asp-action="PrintLotBarcode"
                                               asp-route-barcodeFile="@lot.BarcodeImage"
                                               asp-route-ItemName="@lot.Item.Name"
                                               asp-route-LotNumber="@lot.LotNumber"
                                               asp-route-ExpiryDate="@lot.ExpiryDate">
                                                <i class="bi bi-printer-fill fs-2"></i>
                                            </a>
                                        }
                                    </div>
                                </div>
                            }
                        </div>


                        <div class="d-none d-md-block table-responsive px-2">
                            <div id="Users" class="tabcontent mx-2">
                                <table class="table table-hover display nowrap  px-0 table-bordered border-primary-subtle align-middle" id="tableUser">
                                    <thead>
                                        <tr class="text-center">
                                            <th class=" text-white text-center fs-5" style="background-color:#032b42 !important;">Barcode</th>
                                            <th class=" text-white text-center fs-5" style="background-color:#032b42 !important;">Item</th>
                                            <th class=" text-white text-center fs-5" style="background-color:#032b42 !important;">Expiry Date</th>
                                            <th class=" text-white text-center fs-6" style="background-color:#032b42 !important;">Available<br class="m-0 p-0">Quantity</th>
                                            <th class=" text-white text-center fs-5" style="background-color:#032b42 !important;">Location</th>
                                            <th class=" text-white text-center fs-5" style="background-color:#032b42 !important;">Lot SDS</th>
                                            <th class=" text-white text-center fs-6" style="background-color:#032b42 !important;"> Recived<br class="m-0 p-0">Date</th>
                                            <th class=" text-white text-center fs-6" style="background-color:#032b42 !important;">Manufacture <br class="m-0 p-0">Date</th>

                                            <th class=" text-white text-center fs-5" style="color:#415E72 !important ; background-color:#032b42 !important;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var lot in Model.LotsList)
                                        {
                                            
                                            if (lot.ExpiryDate.Value.Date < DateTime.Now.Date.AddDays(30) && lot.ExpiryDate.Value.Date > DateTime.Now.Date)
                                            {
                                                <tr class="text-center ">

                                                    <td class="fs-6 text-center py-0 px-1 mx-auto  justify-content-center">
                                                        <span class="link-dark fw-bold fs-6"> <img src="@lot.BarcodeImage" style="height:40px" /></span>
                                                        <hr class="p-0 m-0">
                                                        <span class="link-dark " style="font-size:10px">@lot.LotNumber</span>
                                                    </td>
                                                    <td class="fs-6 text-center px-1">
                                                        @if (Model.CanViewItemDetails)
                                                        {
                                                            <a class="link-primary fw-bold text-decoration-none" title="Item Details" asp-controller="Items" asp-action="SelectedItem" asp-route-Id="@lot.ItemId">
                                                                @lot.Item?.Name
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            <span class="link-primary fw-bold text-decoration-none" title="Item Details">
                                                                @lot.Item?.Name
                                                            </span>
                                                        }


                                                    </td>
                                                    <td class="fs-6 text-center px-1 "><span class="fw-bold link-warning">@Convert.ToDateTime(lot.ExpiryDate).ToShortDateString()</span></td>
                                                    <td class="fs-6 text-center px-1 "><span class="link-dark fw-bold">@lot.AvilableQuantity</span></td>
                                                    @* <td class="fs-6 text-center px-1"><span class="link-dark fw-bold">@lot.SupplierLots.FirstOrDefault()</span></td> *@
                                                    <td class="fs-6 text-center px-1 "><span class="link-dark fw-bold">Room[@lot.Location?.RoomNum]</span></td>
                                                    @if (lot.SDS == true)
                                                    {
                                                        <td class="text-center">
                                                            <span class="fw-bold py-2 px-3 bg-success-subtle link-success rounded-5">
                                                                Valid
                                                            </span>
                                                        </td>
                                                    }
                                                    else
                                                    {
                                                        <td class="text-center">
                                                            <span class="fw-bold py-2 px-3 bg-danger-subtle link-danger rounded-5">
                                                                Invalid
                                                            </span>
                                                        </td>
                                                    }

                                                    <td class="fs-6 text-center px-1 "><span class="link-dark ">@Convert.ToDateTime(lot.ReceivedDate).ToShortDateString()</span></td>
                                                    <td class="fs-6 text-center px-1 "><span class="link-dark ">@Convert.ToDateTime(lot.ManufactureDate).ToShortDateString()</span></td>

                                                    <td class="py-1">

                                                        @if (Model.CanViewDetails)
                                                        {
                                                            <a class="btn fw-bold btn-outline-dark bg-transparent border-0 text-center p-0 mx-1 fs-5" title="Details" asp-controller="Lots" asp-action="SelectedLot" asp-route-Id="@lot.Id"><i class="bi bi-eye-fill fs-4"></i><br></a>
                                                        }
                                                        @if (Model.CanEditLot)
                                                        {
                                                            <span class="icon-btn text-secondary"
                                                                  title="Cannot Edit Lot !"
                                                                  style="cursor:not-allowed; opacity:.45;">

                                                                <i class="bi bi-pencil-square fs-4"></i>
                                                            </span>
                                                        }
                                                        @if (Model.CanDeleteLot)
                                                        {
                                                            <a class="btn fw-bold btn-outline-dark bg-transparent border-0 p-0 mx-1 fs-4" title="Delete" onclick="DeleteLot('@lot.Id')"><i class="bi bi-trash3-fill"></i></a>
                                                        }
                                                        @if (Model.CanPrintBarcode)
                                                        {
                                                            <a id="printBarcode" class="btn fw-bold btn-outline-dark bg-transparent border-0 p-0 mx-1 fs-4" title="Print Lot Barcode" asp-controller="Lots" asp-action="PrintLotBarcode" asp-route-barcodeFile="@lot.BarcodeImage" asp-route-ItemName="@lot.Item.Name" asp-route-LotNumber="@lot.LotNumber" asp-route-ExpiryDate="@lot.ExpiryDate">
                                                                <i class="bi bi-printer-fill"></i>

                                                            </a>
                                                        }
                                                    </td>
                                                </tr>
                                            }

                                            if (lot.ExpiryDate.Value.Date > DateTime.Now.Date.AddDays(30))
                                            {
                                                <tr class="text-center ">

                                                    <td class="fs-6 text-center py-0 px-1 mx-auto justify-content-center">
                                                        <span class="link-dark fw-bold fs-6"> <img src="@lot.BarcodeImage" style="height:40px" /></span>
                                                        <hr class="p-0 m-0">
                                                        <span class="link-dark " style="font-size:10px">@lot.LotNumber</span>
                                                    </td>
                                                    <td class="fs-6 text-center px-1 ">
                                                        @if (Model.CanViewItemDetails)
                                                        {
                                                            <a class="link-primary fw-bold text-decoration-none" title="Item Details" asp-controller="Items" asp-action="SelectedItem" asp-route-Id="@lot.ItemId">
                                                                @lot.Item?.Name
                                                            </a>
                                                        }
                                                        else
                                                        {
                                                            <span class="link-primary fw-bold text-decoration-none" title="Item Details">
                                                                @lot.Item?.Name
                                                            </span>
                                                        }
                                                    </td>
                                                    <td class="fs-6 text-center px-1 "><span class="fw-bold link-success">@Convert.ToDateTime(lot.ExpiryDate).ToShortDateString()</span></td>
                                                    <td class="fs-6 text-center px-1 "><span class="link-dark fw-bold">@lot.AvilableQuantity</span></td>
                                                    @* <td class="fs-6 text-center px-1"><span class="link-dark fw-bold">@lot.SupplierLots.FirstOrDefault()</span></td> *@
                                                    <td class="fs-6 text-center px-1 "><span class="link-dark fw-bold">Room[@lot.Location?.RoomNum]</span></td>
                                                    @if (lot.SDS == true)
                                                    {
                                                        <td class="text-center ">
                                                            <span class="fw-bold py-2 px-3 bg-success-subtle link-success rounded-5">
                                                                Valid
                                                            </span>
                                                        </td>
                                                    }
                                                    else
                                                    {
                                                        <td class="text-center ">
                                                            <span class="fw-bold py-2 px-3  bg-danger-subtle link-danger rounded-5">
                                                                Invalid
                                                            </span>
                                                        </td>
                                                    }

                                                    <td class="fs-6 text-center px-1 "><span class="link-dark ">@Convert.ToDateTime(lot.ReceivedDate).ToShortDateString()</span></td>
                                                    <td class="fs-6 text-center px-1 "><span class="link-dark ">@Convert.ToDateTime(lot.ManufactureDate).ToShortDateString()</span></td>


                                                    <td class="py-1">

                                                        @if (Model.CanViewDetails)
                                                        {
                                                            <a class="btn fw-bold btn-outline-dark bg-transparent border-0 text-center p-0 mx-1 fs-5" title="Details" asp-controller="Lots" asp-action="SelectedLot" asp-route-Id="@lot.Id"><i class="bi bi-eye-fill fs-4"></i><br></a>
                                                        }
                                                        @if (Model.CanEditLot)
                                                        {
                                                            <span class="icon-btn text-secondary"
                                                                  title="Cannot Edit Lot !"
                                                                  style="cursor:not-allowed; opacity:.45;">

                                                                <i class="bi bi-pencil-square fs-4"></i>
                                                            </span>
                                                        }
                                                        @if (Model.CanDeleteLot)
                                                        {
                                                            <a class="btn fw-bold btn-outline-dark bg-transparent border-0 p-0 mx-1 fs-4" title="Delete" onclick="DeleteLot('@lot.Id')"><i class="bi bi-trash3-fill"></i></a>
                                                        }
                                                        @if (Model.CanPrintBarcode)
                                                        {
                                                            <a id="printBarcode" class="btn fw-bold btn-outline-dark bg-transparent border-0 p-0 mx-1 fs-4" title="Print Lot Barcode" asp-controller="Lots" asp-action="PrintLotBarcode" asp-route-barcodeFile="@lot.BarcodeImage" asp-route-ItemName="@lot.Item.Name" asp-route-LotNumber="@lot.LotNumber" asp-route-ExpiryDate="@lot.ExpiryDate">
                                                                <i class="bi bi-printer-fill"></i>

                                                            </a>
                                                        }

                                                    </td>
                                                </tr>
                                            }

                                        }

                                    </tbody>
                                </table>
                            </div>
                        </div>


                    }
                </div>
            </div>
        </div>
        <div class="col-md-1"></div>
    </div>
</section>

<partial name="_SaveLot" />
<partial name="_ExpiryLots" />
<partial name="_ListItems" />
<partial name="_ListItemsDis" />

@section Scripts {
    <script src="~/js/Users.js"></script>
    @if (!string.IsNullOrEmpty(Context.Session.GetString(Helper.MsgType)))
    {
        if (Context.Session.GetString(Helper.MsgType) == Helper.Success)
        {
            <script>

                Swal.fire({
                    title: '@Context.Session.GetString(Helper.Title)',
                    text: '@Html.Raw(@Context.Session.GetString(Helper.Msg))',
                    confirmButtonText: 'Ok',
                    icon: 'success'
                });
            </script>

        }
        else
        {
            <script>

                Swal.fire({
                    title: '@Context.Session.GetString(Helper.Title)',
                    text: '@Html.Raw(@Context.Session.GetString(Helper.Msg))',
                    confirmButtonText: 'Ok',
                    icon: 'error'
                });
            </script>
        }
        Context.Session.SetString(Helper.MsgType, "");
    }

    <script>

        let lbTitleEdit = '@Html.Raw("Edit Lot")';
        let lbEdit = '@Html.Raw("Save Changes")';
        let lbAddNewRole = '@Html.Raw("Add New Lot")';
        let lbbtnSave = '@Html.Raw("Save Data")';

        let lbTitleMsgDelete = '@Html.Raw("Delete Lot")';
        let lbTextMsgDelete = '@Html.Raw($"Are you sure !  Do you want to delete the Lot data and everything related to it, including requests and records? ")';
        let lbconfirmButtonText = '@Html.Raw("Yes , Remove")';
        let lbcancelButtonText = '@Html.Raw("Cancle")';

        let lbTitleDeletedOk = '@Html.Raw("Delete Lot Done")';
        let lbMsgDeletedOkRole = '@Html.Raw("The Lot data has been successfully deleted!")';
        let lbSuccess = '@Html.Raw(Helper.Success)';

    </script>

    <script>
        (function () {

            const modal = document.getElementById('ListItemsModalExchange');
            if (!modal) return;

            const input = modal.querySelector('#itemsSearchInputExchange');
            const cards = modal.querySelectorAll('.item-card');
            const scanMsg = modal.querySelector('#scanMessageExchange');

            let scanTimer;

            input.addEventListener('input', function () {
                clearTimeout(scanTimer);

                scanTimer = setTimeout(() => {
                    const value = input.value.trim();
                    handleScan(value);
                    input.value = '';
                }, 300);
            });

            function handleScan(code) {
                if (!code) return;

                scanMsg.classList.add('d-none');

                const matches = [...cards].filter(card =>
                    card.dataset.barcode === code
                );

                if (matches.length === 0) {
                    scanMsg.classList.remove('d-none');
                    return;
                }

                if (matches.length === 1) {
                    const btn = matches[0].querySelector(
                        '.action-btn[data-action="exchange"]'
                    );
                    if (btn) btn.click();
                }
            }

            modal.addEventListener('shown.bs.modal', () => {
                input.focus();
            });

        })();
    </script>


    <script>
        (function() {
            const modal = document.getElementById('ListItemsModalCreate');
            if (!modal) return;

            const input = modal.querySelector('#itemsSearchInputCreate');
            const cards = modal.querySelectorAll('.item-card');
            const scanMsg = modal.querySelector('#scanMessageCreate');

            let timer;
            input.addEventListener('input', () => {
                clearTimeout(timer);
                timer = setTimeout(() => {
                    const code = input.value.trim();
                    input.value = '';
                    scanMsg.classList.add('d-none');
                    const match = [...cards].find(c => c.dataset.barcode === code);
                    if (!match) return scanMsg.classList.remove('d-none');
                    const btn = match.querySelector('.action-btn[data-action="create"]');
                    if (btn) btn.click();
                }, 300);
            });

            modal.addEventListener('shown.bs.modal', () => input.focus());
        })();
    </script>
}





